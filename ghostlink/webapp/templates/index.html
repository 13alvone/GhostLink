<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>GhostLink Web</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
  <div id="loading-overlay"><div class="spinner"></div></div>
  <section class="section">
    <div class="container">
      <h1 class="title has-text-centered">GhostLink Web Interface</h1>
      <div class="columns is-variable is-8">
        <div class="column">
          <h2 class="subtitle">Encode</h2>
          <form id="encode-form" class="box" action="/encode" method="post" enctype="multipart/form-data">
            <div class="field">
              <label class="label" for="text-input">Text to encode</label>
              <div class="control">
                <textarea class="textarea" id="text-input" name="text" placeholder="Enter text"></textarea>
              </div>
            </div>
            <div class="field">
              <label class="label" for="file-input">File to encode</label>
              <div class="control">
                <input class="input" id="file-input" type="file" name="file">
              </div>
            </div>
            <div class="field">
              <label class="label" for="samplerate-input">Sample rate</label>
              <div class="control">
                <input class="input" id="samplerate-input" type="number" name="samplerate" value="48000" title="Output WAV sample rate in Hz">
              </div>
            </div>
            <div class="field">
              <label class="label" for="baud-input">Baud</label>
              <div class="control">
                <input class="input" id="baud-input" type="number" step="0.1" name="baud" value="90.0" title="Symbols per second">
              </div>
            </div>
            <div class="field">
              <label class="label" for="amp-input">Amplitude</label>
              <div class="control">
                <input class="input" id="amp-input" type="number" step="0.01" name="amp" value="0.06" title="Peak amplitude 0-1">
              </div>
            </div>
            <div class="field">
              <label class="label" for="mode-select">FSK mode</label>
              <div class="control">
                <div class="select">
                  <select id="mode-select" name="mode" title="Dense uses 8 tones; sparse uses 4">
                    <option value="dense" selected>Dense (8-FSK)</option>
                    <option value="sparse">Sparse (4-FSK)</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="field">
              <label class="label" for="mix-select">Mix profile</label>
              <div class="control">
                <div class="select">
                  <select id="mix-select" name="mix_profile" title="Carrier frequency set">
                    <option value="streaming" selected>Streaming</option>
                    <option value="studio">Studio</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="field">
              <label class="label" for="preamble-input">Preamble (s)</label>
              <div class="control">
                <input class="input" id="preamble-input" type="number" step="0.1" name="preamble_s" value="0.8" title="Seconds of preamble before data">
              </div>
            </div>
            <div class="field">
              <label class="label" for="gap-input">Gap (ms)</label>
              <div class="control">
                <input class="input" id="gap-input" type="number" step="0.1" name="gap_ms" value="0" title="Intersymbol gap in milliseconds">
              </div>
            </div>
            <div class="field">
              <label class="label" for="interleave-input">Interleave</label>
              <div class="control">
                <input class="input" id="interleave-input" type="number" name="interleave_depth" value="4" title="Interleaving depth for error correction">
              </div>
            </div>
            <div class="field">
              <label class="label" for="repeats-input">Repeats</label>
              <div class="control">
                <input class="input" id="repeats-input" type="number" name="repeats" value="2" title="Number of times to repeat payload">
              </div>
            </div>
            <div class="field">
              <label class="label" for="ramp-input">Ramp (ms)</label>
              <div class="control">
                <input class="input" id="ramp-input" type="number" step="0.1" name="ramp_ms" value="5.0" title="Raised-cosine ramp length per symbol">
              </div>
            </div>
            <div class="field">
              <label class="label" for="out-name-input">Output name</label>
              <div class="control">
                <input class="input" id="out-name-input" type="text" name="out_name" placeholder="Optional" title="Base filename for output">
              </div>
            </div>
            <p id="encode-error" class="help is-danger"></p>
            <div class="field">
              <div class="control">
                <button class="button is-link" type="submit">Encode</button>
              </div>
            </div>
          </form>
        </div>
        <div class="column">
          <h2 class="subtitle">Decode</h2>
          <form id="decode-form" class="box" action="/decode" method="post" enctype="multipart/form-data">
            <div class="field">
              <label class="label" for="wav-input">WAV file</label>
              <div class="control">
                <input class="input" id="wav-input" type="file" name="wav">
              </div>
            </div>
            <div class="field">
              <label class="label" for="d-baud-input">Baud</label>
              <div class="control">
                <input class="input" id="d-baud-input" type="number" step="0.1" name="baud" value="90.0" title="Symbols per second">
              </div>
            </div>
            <div class="field">
              <label class="label" for="d-mode-select">FSK mode</label>
              <div class="control">
                <div class="select">
                  <select id="d-mode-select" name="mode" title="Dense uses 8 tones; sparse uses 4">
                    <option value="dense" selected>Dense (8-FSK)</option>
                    <option value="sparse">Sparse (4-FSK)</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="field">
              <label class="label" for="d-mix-select">Mix profile</label>
              <div class="control">
                <div class="select">
                  <select id="d-mix-select" name="mix_profile" title="Carrier frequency set">
                    <option value="streaming" selected>Streaming</option>
                    <option value="studio">Studio</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="field">
              <label class="label" for="d-preamble-input">Preamble (s)</label>
              <div class="control">
                <input class="input" id="d-preamble-input" type="number" step="0.1" name="preamble_s" value="0.8" title="Seconds of preamble before data">
              </div>
            </div>
            <div class="field">
              <label class="label" for="d-interleave-input">Interleave</label>
              <div class="control">
                <input class="input" id="d-interleave-input" type="number" name="interleave_depth" value="4" title="Interleaving depth for error correction">
              </div>
            </div>
            <div class="field">
              <label class="label" for="d-repeats-input">Repeats</label>
              <div class="control">
                <input class="input" id="d-repeats-input" type="number" name="repeats" value="2" title="Number of times payload was repeated">
              </div>
            </div>
            <p id="decode-error" class="help is-danger"></p>
            <div class="field">
              <div class="control">
                <button class="button is-link" type="submit">Decode</button>
              </div>
            </div>
            <div class="field">
              <label class="label" for="decode-output">Decoded text</label>
              <div class="control">
                <textarea class="textarea" id="decode-output" readonly placeholder="Decoded text will appear here"></textarea>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </section>
  <script>
  document.addEventListener('DOMContentLoaded', function () {
    const overlay = document.getElementById('loading-overlay');
    function showOverlay() { overlay.style.display = 'flex'; }
    function hideOverlay() { overlay.style.display = 'none'; }
    function setDisabled(form, disabled) {
      form.querySelectorAll('input, textarea, button, select').forEach(el => {
        el.disabled = disabled;
      });
    }

    const encodeForm = document.getElementById('encode-form');
    const textInput = document.getElementById('text-input');
    const fileInput = document.getElementById('file-input');
    const encodeError = document.getElementById('encode-error');

    encodeForm.addEventListener('submit', async function (e) {
      const text = textInput.value.trim();
      const file = fileInput.files[0];
      encodeError.textContent = '';

      if (text && file) {
        e.preventDefault();
        encodeError.textContent = 'Provide either text or file, not both.';
        return;
      }
      if (!text && !file) {
        e.preventDefault();
        encodeError.textContent = 'Provide text or file.';
        return;
      }

      e.preventDefault();
      const formData = new FormData(encodeForm);
      if (file) {
        formData.delete('text');
      } else {
        formData.delete('file');
      }

      showOverlay();
      setDisabled(encodeForm, true);
      try {
        const response = await fetch('/encode', { method: 'POST', body: formData });
        if (!response.ok) {
          const data = await response.json().catch(() => ({ detail: 'Server error' }));
          encodeError.textContent = data.detail || 'Server error';
          return;
        }

        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        const disposition = response.headers.get('Content-Disposition');
        let filename = 'output.wav';
        if (disposition) {
          const match = disposition.match(/filename="?([^";]+)"?/);
          if (match) filename = match[1];
        }
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(url);
      } catch (err) {
        encodeError.textContent = 'Network error';
      } finally {
        hideOverlay();
        setDisabled(encodeForm, false);
      }
    });

    const decodeForm = document.getElementById('decode-form');
    const decodeError = document.getElementById('decode-error');
    const decodeOutput = document.getElementById('decode-output');

    decodeForm.addEventListener('submit', async function (e) {
      e.preventDefault();
      decodeError.textContent = '';
      decodeOutput.value = '';
      const formData = new FormData(decodeForm);

      showOverlay();
      setDisabled(decodeForm, true);
      try {
        const response = await fetch('/decode', { method: 'POST', body: formData });
        if (!response.ok) {
          const data = await response.json().catch(() => ({ detail: 'Server error' }));
          decodeError.textContent = data.detail || 'Server error';
          return;
        }
        const text = await response.text();
        decodeOutput.value = text;
      } catch (err) {
        decodeError.textContent = 'Network error';
      } finally {
        hideOverlay();
        setDisabled(decodeForm, false);
      }
    });
  });
  </script>
</body>
</html>
